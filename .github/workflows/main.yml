name: Build Samsung Stock Kernel 4.19.325

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-kernel:
    runs-on: ubuntu-latest

    env:
      ARCH: arm64
      SUBARCH: arm64
      CROSS_COMPILE: ${{ github.workspace }}/toolchain/bin/aarch64-linux-android-

    steps:
      - name: Checkout kernel source
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Setup dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses-dev bison flex libssl-dev bc wget unzip curl git python3

      - name: Download toolchain
        run: |
          mkdir -p toolchain
          curl -L https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/+archive/refs/heads/master.tar.gz | tar xz -C toolchain --strip-components=1
          chmod +x toolchain/bin/*

      - name: Patch kernel version
        run: |
          sed -i 's/^SUBLEVEL = .*/SUBLEVEL = 325/' Makefile
          sed -i '/^EXTRAVERSION =/d' Makefile
          echo "EXTRAVERSION = -OneUI7" >> Makefile

      - name: Prepare kernel config
        run: |
          cp arch/arm64/configs/y2q_defconfig .config

          # Use 'scripts/kconfig/merge_config.sh' if available
          make olddefconfig

      - name: Enable BPF options
        run: |
          scripts/config --file .config \
            --enable CONFIG_BPF \
            --enable CONFIG_BPF_SYSCALL \
            --enable CONFIG_HAVE_EBPF_JIT \
            --enable CONFIG_BPF_JIT \
            --enable CONFIG_CGROUP_BPF \
            --enable CONFIG_BPF_EVENTS \
            --enable CONFIG_NETFILTER_XT_MATCH_BPF
          make olddefconfig

      - name: Build the kernel
        run: |
          make -j$(nproc)

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: kernel-build
          path: arch/arm64/boot/Image.gz-dtb
